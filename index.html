<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous</title>
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #2a2a3e;
            --bg-tertiary: #3a3a52;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0c0;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --border: #3a3a52;
            --success: #51cf66;
            --error: #ff6b6b;
            --warning: #ffd700;
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1e1e2e;
            --text-secondary: #4a4a5a;
            --border: #d0d0d0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-box {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
        }

        .auth-box h1 {
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
        }

        .auth-box p {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .pfp-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pfp-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            overflow: hidden;
        }

        .pfp-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn {
            width: 100%;
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            width: auto;
        }

        .switch-auth {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
        }

        .switch-auth a {
            color: var(--accent-primary);
            cursor: pointer;
            text-decoration: none;
        }

        /* Main App */
        .app-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            font-size: 2em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 25px;
        }

        .user-pfp {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .user-pfp img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-rank {
            font-size: 0.85em;
            background: var(--warning);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .user-rank.owner-rank {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .card.owner-post {
            border-left: 4px solid #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 165, 0, 0.05) 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .card.rank1-post {
            border-left: 4px solid #FF8C00;
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.05) 0%, rgba(255, 140, 0, 0.05) 100%);
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.2);
        }

        .card.rank2-post {
            border-left: 4px solid #8B4513;
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.05) 0%, rgba(139, 69, 19, 0.05) 100%);
            box-shadow: 0 0 15px rgba(139, 69, 19, 0.2);
        }

        .card.rank3-post {
            border-left: 4px solid #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 255, 0, 0.05) 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .card.terrorist-post {
            border-left: 4px solid #FF0000;
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.05) 0%, rgba(200, 0, 0, 0.05) 100%);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .mention {
            color: var(--accent-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .mention:hover {
            text-decoration: underline;
        }

        .owner-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 700;
            margin-left: 5px;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
        }

        .logout-btn {
            background: rgba(255, 107, 107, 0.3);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
        }

        /* Search Bar */
        .search-bar {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 1em;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: var(--bg-tertiary);
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            gap: 10px;
        }

        .card-author {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .author-pfp {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            overflow: hidden;
        }

        .author-pfp img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .author-info {
            display: flex;
            flex-direction: column;
        }

        .author-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .author-rank {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .card-title {
            font-size: 1.4em;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .card-text {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .card-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .card-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 15px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .action-btn:hover {
            background: var(--accent-primary);
            color: white;
        }

        .action-btn.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        /* Quiz Options */
        .quiz-options {
            margin: 15px 0;
        }

        .quiz-option {
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            border-color: var(--accent-primary);
        }

        .quiz-option.selected {
            border-color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: rgba(81, 207, 102, 0.1);
        }

        .quiz-option.incorrect {
            border-color: var(--error);
            background: rgba(255, 107, 107, 0.1);
        }

        /* Poll */
        .poll-option {
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .poll-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            opacity: 0.2;
            transition: width 0.3s;
        }

        .poll-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
        }

        /* Comments */
        .comments-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .comment {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--accent-primary);
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-primary);
            min-width: 40px;
        }

        .leaderboard-pfp {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            overflow: hidden;
        }

        .leaderboard-pfp img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .leaderboard-score {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: rgba(81, 207, 102, 0.2);
            border-left: 4px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid var(--error);
            color: var(--error);
        }

        .alert-info {
            background: rgba(102, 126, 234, 0.2);
            border-left: 4px solid var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-right {
                justify-content: space-between;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-button {
                min-width: 100%;
            }
        }

        .hidden {
            display: none !important;
        }

        .notification-bell {
            position: relative;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .notification-bell:hover {
            background: var(--bg-tertiary);
            transform: scale(1.1);
        }

        .notification-bell.has-notifications {
            animation: ring 2s ease-in-out infinite;
        }

        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-15deg); }
            20%, 40% { transform: rotate(15deg); }
        }

        .notification-count {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .notification-dropdown {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-tertiary);
        }

        .notification-item.unread {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid var(--accent-primary);
        }

        .notification-item .notification-text {
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .notification-item .notification-time {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .edit-btn {
            background: var(--warning);
            color: #000;
        }

        .edit-btn:hover {
            background: #ffa726;
        }

        .edited-badge {
            color: var(--text-secondary);
            font-size: 0.85em;
            font-style: italic;
        }

        .follow-btn {
            padding: 5px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .follow-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        .follow-btn.following {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .random-post-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s;
            z-index: 1000;
        }

        .random-post-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .profile-pfp-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            overflow: hidden;
        }

        .profile-pfp-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-stats {
            display: flex;
            gap: 30px;
            margin-top: 10px;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-number {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .profile-stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-box">
            <h1>üé≠ Anonymous</h1>
            <p id="auth-subtitle">Create your account to get started</p>
            <div id="auth-alert"></div>

            <!-- SIGNUP FORM -->
            <form id="signup-form">
                <div class="form-group">
                    <label for="signup-username">Username *</label>
                    <input type="text" id="signup-username" required placeholder="Choose a unique username">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password *</label>
                    <input type="password" id="signup-password" required placeholder="Create a strong password">
                </div>
                <div class="form-group">
                    <label>Profile Picture (Optional)</label>
                    <div class="pfp-upload">
                        <div class="pfp-preview" id="signup-pfp-preview">
                            üë§
                        </div>
                        <input type="file" id="signup-pfp" accept="image/*">
                    </div>
                </div>
                <button type="submit" class="btn">Create Account</button>
            </form>

            <!-- LOGIN FORM -->
            <form id="login-form" class="hidden">
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>

            <div class="switch-auth">
                <span id="switch-to-login">Already have an account? <a>Login</a></span>
                <span id="switch-to-signup" class="hidden">Don't have an account? <a>Sign Up</a></span>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="app-container">
        <header>
            <h1>üé≠ Anonymous</h1>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-pfp" id="header-pfp">üë§</div>
                    <div>
                        <div id="header-username">User</div>
                        <div class="user-rank" id="header-rank">Member</div>
                    </div>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" class="search-input" id="search-input" placeholder="üîç Search reviews, quizzes, and polls...">
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('reviews')">üìù Messages</button>
            <button class="tab-button" onclick="switchTab('quizzes')">üß† Quizzes</button>
            <button class="tab-button" onclick="switchTab('polls')">üìä Polls</button>
            <button class="tab-button" onclick="switchTab('favorites')">‚≠ê Favorites</button>
            <button class="tab-button" onclick="switchTab('leaderboard')">üèÜ Leaderboard</button>
            <button class="tab-button" onclick="switchTab('follows')">üë• Follows</button>
            <button class="tab-button" onclick="switchTab('profile')">üë§ Profile & Settings</button>
            <button class="tab-button" id="reported-tab-btn" onclick="switchTab('reported')" style="display: none;">üö© Reported</button>
        </div>

        <!-- REVIEWS TAB -->
        <div id="reviews-tab" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Post a Message</h2>
                <div id="review-alert"></div>
                <form id="review-form">
                    <div class="form-group">
                        <label for="review-title">Title *</label>
                        <input type="text" id="review-title" required placeholder="What's your message about?">
                    </div>
                    <div class="form-group">
                        <label for="review-text">Message *</label>
                        <textarea id="review-text" required placeholder="Share your thoughts..." rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Image (Optional)</label>
                        <input type="file" id="review-image" accept="image/*">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="review-anonymous" checked>
                        <label for="review-anonymous">Post anonymously (hide username & profile picture)</label>
                    </div>
                    <button type="submit" class="btn">Post Message</button>
                </form>
            </div>
            <div id="reviews-list"></div>
        </div>

        <!-- QUIZZES TAB -->
        <div id="quizzes-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Create a Quiz</h2>
                <div id="quiz-alert"></div>
                <form id="quiz-form">
                    <div class="form-group">
                        <label for="quiz-title">Quiz Title *</label>
                        <input type="text" id="quiz-title" required placeholder="Name your quiz">
                    </div>
                    <div class="form-group">
                        <label for="quiz-question">Question *</label>
                        <textarea id="quiz-question" required placeholder="What's your question?" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Image (Optional)</label>
                        <input type="file" id="quiz-image" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Answer Options *</label>
                        <div id="quiz-options">
                            <input type="text" class="quiz-option-input" placeholder="Option 1" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            <input type="text" class="quiz-option-input" placeholder="Option 2" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addQuizOption()">+ Add Option</button>
                    </div>
                    <div class="form-group">
                        <label for="quiz-correct">Correct Answer *</label>
                        <select id="quiz-correct" required>
                            <option value="">Select correct answer</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="quiz-anonymous" checked>
                        <label for="quiz-anonymous">Post anonymously</label>
                    </div>
                    <button type="submit" class="btn">Create Quiz</button>
                </form>
            </div>
            <div id="quizzes-list"></div>
        </div>

        <!-- POLLS TAB -->
        <div id="polls-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Create a Poll</h2>
                <div id="poll-alert"></div>
                <form id="poll-form">
                    <div class="form-group">
                        <label for="poll-question">Poll Question *</label>
                        <input type="text" id="poll-question" required placeholder="What do you want to ask?">
                    </div>
                    <div class="form-group">
                        <label>Poll Options *</label>
                        <div id="poll-options">
                            <input type="text" class="poll-option-input" placeholder="Option 1" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            <input type="text" class="poll-option-input" placeholder="Option 2" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addPollOption()">+ Add Option</button>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="poll-anonymous" checked>
                        <label for="poll-anonymous">Post anonymously</label>
                    </div>
                    <button type="submit" class="btn">Create Poll</button>
                </form>
            </div>
            <div id="polls-list"></div>
        </div>

        <!-- FAVORITES TAB -->
        <div id="favorites-tab" class="tab-content">
            <div id="favorites-list"></div>
        </div>

        <!-- LEADERBOARD TAB -->
        <div id="leaderboard-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üèÜ Top Quiz Masters</h2>
                <div id="leaderboard-list"></div>
            </div>
        </div>

        <!-- FOLLOWS LEADERBOARD TAB -->
        <div id="follows-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üë• Most Followed Users</h2>
                <div id="follows-leaderboard"></div>
            </div>
        </div>

        <!-- PROFILE TAB -->
        <div id="profile-tab" class="tab-content">
            <!-- User Profile View (when viewing someone else) -->
            <div id="user-profile-view" style="display: none;">
                <button class="btn btn-secondary" onclick="backToMyProfile()" style="margin-bottom: 20px;">‚Üê Back to My Profile</button>
                <div class="card">
                    <div class="profile-header">
                        <div class="profile-pfp-large" id="view-user-pfp">
                            üë§
                        </div>
                        <div style="flex: 1;">
                            <h2 id="view-user-username">Username</h2>
                            <div id="view-user-rank" style="margin: 10px 0;">Member</div>
                            <div class="profile-stats">
                                <div class="profile-stat">
                                    <div class="profile-stat-number" id="view-user-followers">0</div>
                                    <div class="profile-stat-label">Followers</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="profile-stat-number" id="view-user-following">0</div>
                                    <div class="profile-stat-label">Following</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="profile-stat-number" id="view-user-posts">0</div>
                                    <div class="profile-stat-label">Posts</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <button class="follow-btn" id="view-user-follow-btn" onclick="toggleFollowFromProfile()">Follow</button>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h3>Bio</h3>
                        <p id="view-user-description" style="color: var(--text-secondary); margin-top: 10px;">No bio yet</p>
                    </div>
                </div>
            </div>

            <!-- My Profile & Settings -->
            <div id="my-profile-view">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">My Profile</h2>
                    <div class="profile-header">
                        <div class="profile-pfp-large" id="profile-pfp-display">
                            üë§
                        </div>
                        <div style="flex: 1;">
                            <h2 id="profile-username-display">Username</h2>
                            <div id="profile-rank-display" style="margin: 10px 0;">Member</div>
                            <div class="profile-stats">
                                <div class="profile-stat">
                                    <div class="profile-stat-number" id="profile-followers">0</div>
                                    <div class="profile-stat-label">Followers</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="profile-stat-number" id="profile-following">0</div>
                                    <div class="profile-stat-label">Following</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="profile-stat-number" id="profile-posts">0</div>
                                    <div class="profile-stat-label">Posts</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Edit Profile</h3>
                    <div id="profile-alert"></div>
                    
                    <div class="form-group">
                        <label for="profile-description">Bio/Description</label>
                        <textarea id="profile-description" rows="3" placeholder="Tell people about yourself..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Change Profile Picture</label>
                        <input type="file" id="profile-pfp-change" accept="image/*">
                    </div>

                    <button class="btn" onclick="updateProfile()">Save Changes</button>
                </div>

                <!-- Following List -->
                <div class="card" style="margin-top: 20px;">
                    <h2 style="margin-bottom: 20px;">People I'm Following</h2>
                    <div id="following-list"></div>
                </div>

                <!-- Settings Section -->
                <div class="card" style="margin-top: 20px;">
                    <h2 style="margin-bottom: 20px;">‚öôÔ∏è Account Settings</h2>
                    
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="settings-username" disabled style="opacity: 0.6;">
                    </div>

                    <div class="form-group">
                        <label>Rank</label>
                        <input type="text" id="settings-rank" disabled style="opacity: 0.6;">
                    </div>

                    <div class="form-group">
                        <label>Quiz Score</label>
                        <input type="text" id="settings-score" disabled style="opacity: 0.6;">
                    </div>

                    <div class="form-group">
                        <label>Change Password</label>
                        <input type="password" id="settings-new-password" placeholder="Enter new password">
                    </div>

                    <button class="btn" onclick="changePassword()">Update Password</button>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2 style="margin-bottom: 20px;">üé® Appearance</h2>
                    
                    <div class="form-group">
                        <label>Theme</label>
                        <select id="theme-select" onchange="changeTheme()">
                            <option value="dark">Dark Mode</option>
                            <option value="light">Light Mode</option>
                        </select>
                    </div>
                </div>

                <div class="card" id="admin-panel" style="margin-top: 20px; display: none;">
                    <h2 style="margin-bottom: 20px;">üëë Admin Panel</h2>
                    <div id="admin-alert"></div>
                    
                    <div class="form-group">
                        <label>Add Admin User</label>
                        <input type="text" id="admin-username-input" placeholder="Enter username to make admin">
                    </div>
                    
                    <button class="btn" onclick="addAdmin()">Add Admin</button>

                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 10px;">Current Admins:</h3>
                        <div id="admin-list"></div>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border);">

                    <h3 style="margin-bottom: 15px;">Assign Custom Ranks</h3>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="rank-username-input" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label>Rank</label>
                        <select id="rank-select">
                            <option value="Member">Member (Default)</option>
                            <option value="Rank 1">Rank 1 (Orange)</option>
                            <option value="Rank 2: Idiot">Rank 2: Idiot (Brown)</option>
                            <option value="Rank 3: Smart person">Rank 3: Smart person (Yellow)</option>
                            <option value="Potential Terrorist">Potential Terrorist (Red)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="assignRank()">Assign Rank</button>
                </div>

                <div class="card" style="margin-top: 20px; background: rgba(255, 107, 107, 0.1); border-left: 4px solid var(--error);">
                    <h2 style="margin-bottom: 20px; color: var(--error);">‚ö†Ô∏è Danger Zone</h2>
                    <button class="btn btn-danger" onclick="deleteAccount()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">Delete Account</button>
                </div>
            </div>
        </div>

        <!-- REPORTED CONTENT TAB (Owner Only) -->
        <div id="reported-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üö© Reported Content</h2>
                <div id="reported-list"></div>
            </div>
        </div>
    </div>

    <!-- Random Post Button -->
    <button class="random-post-btn" onclick="showRandomPost()" title="Show me something random!">üé≤</button>

    <script>
        // ==========================================
        // CONFIGURATION - REPLACE WITH YOUR VALUES
        // ==========================================
        
        const SUPABASE_URL = 'https://efcdikfgukvqupfzeorz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmY2Rpa2ZndWt2cXVwZnplb3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjUwMzIsImV4cCI6MjA4NjQ0MTAzMn0.kIR2-uXbhCkF3C16SzhdM1NT8j5SeX6yGQaBFoslbVY';
        const OWNER_USERNAME = 'owner'; // Change this to your username to become the Owner

        // Restricted words
        const RESTRICTED_WORDS = ['nigger', 'porn'];

        // Auto-refresh interval (in milliseconds)
        const ADMIN_REFRESH_INTERVAL = 5000; // 5 seconds

        // ==========================================
        // SUPABASE CLIENT
        // ==========================================

        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
                this.currentUser = null;
            }

            async request(endpoint, options = {}) {
                const response = await fetch(`${this.url}/rest/v1/${endpoint}`, {
                    ...options,
                    headers: {
                        'apikey': this.key,
                        'Authorization': `Bearer ${this.key}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const text = await response.text();
                return text ? JSON.parse(text) : [];
            }

            from(table) {
                const self = this;
                return {
                    select: (columns = '*') => {
                        let filters = [];
                        
                        const builder = {
                            eq: (column, value) => {
                                filters.push(`${column}=eq.${encodeURIComponent(value)}`);
                                return builder;
                            },
                            order: (column, options = {}) => {
                                const orderStr = `order=${column}.${options.ascending ? 'asc' : 'desc'}`;
                                return {
                                    execute: () => {
                                        const query = filters.length > 0 ? `&${filters.join('&')}` : '';
                                        return self.request(`${table}?select=${columns}${query}&${orderStr}`);
                                    }
                                };
                            },
                            single: () => ({
                                execute: () => {
                                    const query = filters.length > 0 ? `&${filters.join('&')}` : '';
                                    return self.request(`${table}?select=${columns}${query}&limit=1`)
                                        .then(data => data[0] || null);
                                }
                            }),
                            execute: () => {
                                const query = filters.length > 0 ? `&${filters.join('&')}` : '';
                                return self.request(`${table}?select=${columns}${query}`);
                            }
                        };
                        
                        return builder;
                    },
                    insert: (data) => ({
                        select: () => ({
                            execute: () => self.request(table, {
                                method: 'POST',
                                body: JSON.stringify(data)
                            })
                        })
                    }),
                    update: (data) => {
                        let filters = [];
                        
                        const updateBuilder = {
                            eq: (column, value) => {
                                filters.push(`${column}=eq.${encodeURIComponent(value)}`);
                                return updateBuilder;
                            },
                            execute: () => {
                                const query = filters.length > 0 ? `?${filters.join('&')}` : '';
                                return self.request(`${table}${query}`, {
                                    method: 'PATCH',
                                    body: JSON.stringify(data)
                                });
                            }
                        };
                        
                        return updateBuilder;
                    },
                    delete: () => {
                        let filters = [];
                        
                        const deleteBuilder = {
                            eq: (column, value) => {
                                filters.push(`${column}=eq.${encodeURIComponent(value)}`);
                                return deleteBuilder;
                            },
                            execute: () => {
                                const query = filters.length > 0 ? `?${filters.join('&')}` : '';
                                return self.request(`${table}${query}`, {
                                    method: 'DELETE'
                                });
                            }
                        };
                        
                        return deleteBuilder;
                    }
                };
            }
        }

        const supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function containsRestrictedWords(text) {
            const lowerText = text.toLowerCase();
            return RESTRICTED_WORDS.some(word => lowerText.includes(word.toLowerCase()));
        }

        function showAlert(elementId, message, type = 'info') {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function uploadImage(file) {
            if (!file) return null;
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'reviews') loadReviews();
            else if (tabName === 'quizzes') loadQuizzes();
            else if (tabName === 'polls') loadPolls();
            else if (tabName === 'favorites') loadFavorites();
            else if (tabName === 'leaderboard') loadLeaderboard();
            else if (tabName === 'follows') loadFollowsLeaderboard();
            else if (tabName === 'profile') {
                backToMyProfile(); // Ensure we're on our own profile
                loadProfile();
                loadSettings();
            }
            else if (tabName === 'reported') loadReported();
        }

        // ==========================================
        // AUTHENTICATION
        // ==========================================

        let currentUser = null;
        let isAdmin = false;
        let isOwner = false;
        let adminRefreshTimer = null;

        document.getElementById('switch-to-login').addEventListener('click', () => {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('switch-to-login').classList.add('hidden');
            document.getElementById('switch-to-signup').classList.remove('hidden');
            document.getElementById('auth-subtitle').textContent = 'Welcome back!';
        });

        document.getElementById('switch-to-signup').addEventListener('click', () => {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('switch-to-signup').classList.add('hidden');
            document.getElementById('switch-to-login').classList.remove('hidden');
            document.getElementById('auth-subtitle').textContent = 'Create your account to get started';
        });

        document.getElementById('signup-pfp').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById('signup-pfp-preview');
                const dataUrl = await uploadImage(file);
                preview.innerHTML = `<img src="${dataUrl}" alt="PFP">`;
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value;
            const pfpFile = document.getElementById('signup-pfp').files[0];

            if (containsRestrictedWords(username)) {
                showAlert('auth-alert', '‚ùå Username contains restricted words', 'error');
                return;
            }

            try {
                // Check if username exists
                const existing = await supabase.from('users').select('*').eq('username', username).single().execute();
                if (existing) {
                    showAlert('auth-alert', '‚ùå Username already taken', 'error');
                    return;
                }

                const pfpData = pfpFile ? await uploadImage(pfpFile) : null;
                
                // Check if this is the owner
                const rank = username.toLowerCase() === OWNER_USERNAME.toLowerCase() ? 'Owner' : 'Member';

                const users = await supabase.from('users').insert({
                    username: username,
                    password: password,
                    pfp: pfpData,
                    rank: rank,
                    description: '',
                    quiz_score: 0,
                    created_at: new Date().toISOString()
                }).select().execute();

                currentUser = users[0];
                localStorage.setItem('currentUserId', currentUser.id);
                
                // Check if user is admin or owner
                await checkAdminStatus();
                
                showApp();
            } catch (error) {
                console.error('Signup error:', error);
                showAlert('auth-alert', '‚ùå Error creating account', 'error');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            try {
                const user = await supabase.from('users').select('*').eq('username', username).single().execute();
                
                if (!user || user.password !== password) {
                    showAlert('auth-alert', '‚ùå Invalid username or password', 'error');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUserId', currentUser.id);
                
                // Check if user is admin
                await checkAdminStatus();
                
                showApp();
            } catch (error) {
                console.error('Login error:', error);
                showAlert('auth-alert', '‚ùå Invalid username or password', 'error');
            }
        });

        async function checkAuth() {
            const userId = localStorage.getItem('currentUserId');
            if (userId) {
                try {
                    const user = await supabase.from('users').select('*').eq('id', userId).single().execute();
                    if (user) {
                        currentUser = user;
                        await checkAdminStatus();
                        showApp();
                        return;
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                }
            }
            showAuth();
        }

        async function checkAdminStatus() {
            try {
                // Check if owner
                isOwner = currentUser.username.toLowerCase() === OWNER_USERNAME.toLowerCase();
                
                if (isOwner && currentUser.rank !== 'Owner') {
                    await supabase.from('users').update({ rank: 'Owner' }).eq('id', currentUser.id).execute();
                    currentUser.rank = 'Owner';
                }
                
                // Check if admin
                const admin = await supabase.from('admins').select('*').eq('user_id', currentUser.id).single().execute();
                isAdmin = !!admin || isOwner; // Owner is also admin
                
                // Update user rank in database if they're admin but not owner
                if (isAdmin && !isOwner && currentUser.rank !== 'Admin') {
                    await supabase.from('users').update({ rank: 'Admin' }).eq('id', currentUser.id).execute();
                    currentUser.rank = 'Admin';
                } else if (!isAdmin && !isOwner && currentUser.rank === 'Admin') {
                    await supabase.from('users').update({ rank: 'Member' }).eq('id', currentUser.id).execute();
                    currentUser.rank = 'Member';
                }
            } catch (error) {
                isAdmin = isOwner; // Owner is always admin
            }
        }

        function startAdminRefresh() {
            // Clear any existing timer
            if (adminRefreshTimer) {
                clearInterval(adminRefreshTimer);
            }
            
            // Refresh admin status periodically
            adminRefreshTimer = setInterval(async () => {
                const oldAdminStatus = isAdmin;
                await checkAdminStatus();
                
                // If admin status changed, update UI
                if (oldAdminStatus !== isAdmin) {
                    document.getElementById('header-rank').textContent = currentUser.rank;
                    loadSettings();
                    
                    // Reload current tab to show/hide delete buttons
                    const activeTab = document.querySelector('.tab-button.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.includes('Reviews') ? 'reviews' :
                                      activeTab.textContent.includes('Quizzes') ? 'quizzes' :
                                      activeTab.textContent.includes('Polls') ? 'polls' :
                                      activeTab.textContent.includes('Favorites') ? 'favorites' :
                                      activeTab.textContent.includes('Leaderboard') ? 'leaderboard' : 'settings';
                        
                        if (tabName === 'reviews') loadReviews();
                        else if (tabName === 'quizzes') loadQuizzes();
                        else if (tabName === 'polls') loadPolls();
                    }
                }
            }, ADMIN_REFRESH_INTERVAL);
        }

        function showAuth() {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
            
            // Stop admin refresh
            if (adminRefreshTimer) {
                clearInterval(adminRefreshTimer);
                adminRefreshTimer = null;
            }
        }

        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            
            document.getElementById('header-username').textContent = currentUser.username;
            
            // Update rank display with special styling for owner
            const rankElement = document.getElementById('header-rank');
            rankElement.textContent = currentUser.rank;
            if (isOwner) {
                rankElement.classList.add('owner-rank');
            } else {
                rankElement.classList.remove('owner-rank');
            }
            
            if (currentUser.pfp) {
                document.getElementById('header-pfp').innerHTML = `<img src="${currentUser.pfp}" alt="PFP">`;
            }

            // Show reported tab for owner
            if (isOwner) {
                document.getElementById('reported-tab-btn').style.display = 'block';
            } else {
                document.getElementById('reported-tab-btn').style.display = 'none';
            }

            loadReviews();
            loadSettings();
            startAdminRefresh();
        }

        function logout() {
            localStorage.removeItem('currentUserId');
            currentUser = null;
            isAdmin = false;
            
            if (adminRefreshTimer) {
                clearInterval(adminRefreshTimer);
                adminRefreshTimer = null;
            }
            
            showAuth();
        }

        // ==========================================
        // REVIEWS
        // ==========================================

        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('review-title').value.trim();
            const text = document.getElementById('review-text').value.trim();
            const imageFile = document.getElementById('review-image').files[0];
            const anonymous = document.getElementById('review-anonymous').checked;

            if (containsRestrictedWords(title) || containsRestrictedWords(text)) {
                showAlert('review-alert', '‚ùå Content contains restricted words', 'error');
                return;
            }

            try {
                const imageData = imageFile ? await uploadImage(imageFile) : null;

                await supabase.from('reviews').insert({
                    user_id: currentUser.id,
                    username: anonymous ? null : currentUser.username,
                    user_pfp: anonymous ? null : currentUser.pfp,
                    user_rank: anonymous ? null : currentUser.rank,
                    title: title,
                    text: text,
                    image: imageData,
                    likes: 0,
                    reports: 0,
                    created_at: new Date().toISOString()
                }).select().execute();

                showAlert('review-alert', '‚úÖ Review posted!', 'success');
                document.getElementById('review-form').reset();
                loadReviews();
            } catch (error) {
                console.error('Post review error:', error);
                showAlert('review-alert', '‚ùå Error posting review', 'error');
            }
        });

        async function loadReviews() {
            const listDiv = document.getElementById('reviews-list');
            listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div>Loading...</div>';

            try {
                const reviews = await supabase.from('reviews').select('*').order('created_at', { ascending: false }).execute();
                
                if (reviews.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><div>No messages yet</div></div>';
                    return;
                }

                listDiv.innerHTML = reviews.map(review => renderReview(review)).join('');
                updateFollowButtons();
            } catch (error) {
                console.error('Load reviews error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">‚ùå Error loading messages</div>';
            }
        }

        function renderReview(review) {
            const liked = isLiked('review', review.id);
            const favorited = isFavorited('review', review.id);
            const anonymous = !review.username;
            const isOwnerPost = review.user_rank === 'Owner';
            const canFollow = !anonymous && review.user_id !== currentUser.id;
            
            // Determine card class based on rank
            let cardClass = '';
            if (isOwnerPost) cardClass = 'owner-post';
            else if (review.user_rank === 'Rank 1') cardClass = 'rank1-post';
            else if (review.user_rank === 'Rank 2: Idiot') cardClass = 'rank2-post';
            else if (review.user_rank === 'Rank 3: Smart person') cardClass = 'rank3-post';
            else if (review.user_rank === 'Potential Terrorist') cardClass = 'terrorist-post';

            // Process mentions in text
            const processedText = processMentions(review.text);

            return `
                <div class="card ${cardClass}">
                    <div class="card-header">
                        <div class="card-author">
                            <div class="author-pfp">
                                ${anonymous ? 'üë§' : (review.user_pfp ? `<img src="${review.user_pfp}">` : 'üë§')}
                            </div>
                            <div class="author-info">
                                <div class="author-name" style="${!anonymous ? 'cursor: pointer; text-decoration: underline;' : ''}" ${!anonymous ? `onclick="viewUserProfile(${review.user_id})"` : ''}>
                                    ${anonymous ? 'Anonymous' : escapeHtml(review.username)}
                                    ${isOwnerPost ? '<span class="owner-badge">üëë OWNER</span>' : ''}
                                </div>
                                <div class="author-rank">${anonymous ? '' : review.user_rank}</div>
                            </div>
                        </div>
                        ${canFollow ? `<button class="follow-btn" onclick="toggleFollow(${review.user_id})" id="follow-btn-${review.user_id}">Follow</button>` : ''}
                    </div>
                    <div class="card-title">${escapeHtml(review.title)}</div>
                    ${review.image ? `<img src="${review.image}" class="card-image">` : ''}
                    <div class="card-text">${processedText}</div>
                    <div class="card-meta">
                        <span>üëç ${review.likes}</span>
                        <span>üö© ${review.reports}</span>
                        <span>üïí ${formatTimeAgo(review.created_at)}</span>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn ${liked ? 'active' : ''}" onclick="toggleLike('review', ${review.id})">
                            üëç Like
                        </button>
                        <button class="action-btn ${favorited ? 'active' : ''}" onclick="toggleFavorite('review', ${review.id})">
                            ‚≠ê Favorite
                        </button>
                        <button class="action-btn" onclick="reportContent('review', ${review.id})">
                            üö© Report
                        </button>
                        <button class="action-btn" onclick="showComments('review', ${review.id})">
                            üí¨ Comments
                        </button>
                        ${(isAdmin || isOwner || review.user_id === currentUser.id) ? `<button class="action-btn" style="background: var(--error); color: white;" onclick="deleteOwnPost('review', ${review.id}, ${review.user_id})">üóëÔ∏è Delete</button>` : ''}
                    </div>
                    <div id="comments-review-${review.id}" class="comments-section hidden"></div>
                </div>
            `;
        }

        function processMentions(text) {
            if (!text) return '';
            // Convert @username to clickable mentions
            return escapeHtml(text).replace(/@(\w+)/g, '<span class="mention" onclick="mentionUser(\'$1\')">@$1</span>');
        }

        async function mentionUser(username) {
            try {
                const user = await supabase.from('users').select('*').eq('username', username).single().execute();
                if (user) {
                    viewUserProfile(user.id);
                } else {
                    alert('User not found');
                }
            } catch (error) {
                alert('User not found');
            }
        }

        async function toggleLike(type, id) {
            const key = `${type}_${id}`;
            const likes = JSON.parse(localStorage.getItem('likes') || '{}');

            const table = type === 'review' ? 'reviews' : type === 'quiz' ? 'quizzes' : 'polls';
            const item = await supabase.from(table).select('*').eq('id', id).single().execute();

            if (likes[key]) {
                // Unlike
                if (!confirm('Unlike this?')) return;
                
                await supabase.from(table).update({ likes: item.likes - 1 }).eq('id', id).execute();
                delete likes[key];
                localStorage.setItem('likes', JSON.stringify(likes));
            } else {
                // Like
                await supabase.from(table).update({ likes: item.likes + 1 }).eq('id', id).execute();
                likes[key] = true;
                localStorage.setItem('likes', JSON.stringify(likes));
            }

            if (type === 'review') loadReviews();
            else if (type === 'quiz') loadQuizzes();
            else if (type === 'poll') loadPolls();
        }

        function isLiked(type, id) {
            const likes = JSON.parse(localStorage.getItem('likes') || '{}');
            return likes[`${type}_${id}`] || false;
        }

        async function reportContent(type, id) {
            if (!confirm('Report this content?')) return;

            try {
                const table = type === 'review' ? 'reviews' : type === 'quiz' ? 'quizzes' : 'polls';
                const item = await supabase.from(table).select('*').eq('id', id).single().execute();
                
                await supabase.from(table).update({ reports: item.reports + 1 }).eq('id', id).execute();

                showAlert('review-alert', '‚úÖ Content reported', 'success');
                if (type === 'review') loadReviews();
                else if (type === 'quiz') loadQuizzes();
                else if (type === 'poll') loadPolls();
            } catch (error) {
                console.error('Report error:', error);
            }
        }

        async function toggleFavorite(type, id) {
            const key = `${type}_${id}`;
            const favorites = JSON.parse(localStorage.getItem('favorites') || '{}');

            favorites[key] = !favorites[key];
            localStorage.setItem('favorites', JSON.stringify(favorites));

            if (type === 'review') loadReviews();
            else if (type === 'quiz') loadQuizzes();
            else if (type === 'poll') loadPolls();
        }

        function isFavorited(type, id) {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
            return favorites[`${type}_${id}`] || false;
        }

        async function showComments(type, id) {
            const commentsDiv = document.getElementById(`comments-${type}-${id}`);
            
            if (!commentsDiv.classList.contains('hidden')) {
                commentsDiv.classList.add('hidden');
                return;
            }

            commentsDiv.classList.remove('hidden');
            commentsDiv.innerHTML = '<div>Loading comments...</div>';

            try {
                const comments = await supabase.from('comments')
                    .select('*')
                    .eq('content_type', type)
                    .eq('content_id', id)
                    .order('created_at', { ascending: true })
                    .execute();

                const commentsHtml = await Promise.all(comments.map(async c => {
                    // Get user info if not anonymous
                    let userPfp = 'üë§';
                    let displayName = escapeHtml(c.nickname || c.username);
                    
                    if (!c.anonymous && c.user_id) {
                        try {
                            const user = await supabase.from('users').select('pfp, username').eq('id', c.user_id).single().execute();
                            if (user) {
                                userPfp = user.pfp ? `<img src="${user.pfp}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§';
                                displayName = c.nickname ? escapeHtml(c.nickname) : escapeHtml(user.username);
                            }
                        } catch (e) {
                            // Use default if user lookup fails
                        }
                    }

                    return `
                        <div class="comment" id="comment-${c.id}">
                            <div style="display: flex; align-items: start; gap: 10px; margin-bottom: 10px;">
                                <div style="width: 35px; height: 35px; min-width: 35px; border-radius: 50%; background: var(--bg-tertiary); overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                    ${userPfp}
                                </div>
                                <div style="flex: 1;">
                                    <div class="comment-author">${displayName}</div>
                                    <div style="margin-top: 5px;">${escapeHtml(c.text)}</div>
                                    <div style="margin-top: 5px; font-size: 0.85em; color: var(--text-secondary);">
                                        <span>${formatTimeAgo(c.created_at)}</span>
                                        ${(isAdmin || isOwner || c.user_id === currentUser.id) ? `<span style="margin-left: 10px; cursor: pointer; color: var(--error);" onclick="deleteComment(${c.id}, '${type}', ${id})">Delete</span>` : ''}
                                        <span style="margin-left: 10px; cursor: pointer; color: var(--accent-primary);" onclick="replyToComment(${c.id}, '${displayName.replace(/'/g, "\\'")}', '${type}', ${id})">Reply</span>
                                    </div>
                                </div>
                            </div>
                            <div id="replies-${c.id}" style="margin-left: 45px;"></div>
                        </div>
                    `;
                }));

                commentsDiv.innerHTML = `
                    ${commentsHtml.join('')}
                    <div style="margin-top: 15px;">
                        <input type="text" id="comment-nickname-${type}-${id}" placeholder="Nickname (optional)" style="width: 100%; padding: 8px; margin-bottom: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <textarea id="comment-text-${type}-${id}" placeholder="Add a comment..." rows="2" style="width: 100%; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); margin-bottom: 10px;"></textarea>
                        <div class="checkbox-group" style="margin-bottom: 10px;">
                            <input type="checkbox" id="comment-anonymous-${type}-${id}">
                            <label for="comment-anonymous-${type}-${id}">Post anonymously (hide profile picture)</label>
                        </div>
                        <button class="btn" onclick="postComment('${type}', ${id})">Post Comment</button>
                    </div>
                `;

                // Load replies for each comment
                for (const comment of comments) {
                    await loadReplies(comment.id);
                }
            } catch (error) {
                console.error('Load comments error:', error);
                commentsDiv.innerHTML = '<div class="alert alert-error">Error loading comments</div>';
            }
        }

        async function loadReplies(commentId) {
            try {
                const replies = await supabase.from('replies')
                    .select('*')
                    .eq('comment_id', commentId)
                    .order('created_at', { ascending: true })
                    .execute();

                const repliesDiv = document.getElementById(`replies-${commentId}`);
                if (!repliesDiv) return;

                if (replies.length === 0) {
                    repliesDiv.innerHTML = '';
                    return;
                }

                const repliesHtml = await Promise.all(replies.map(async r => {
                    // Get user info if not anonymous
                    let userPfp = 'üë§';
                    let displayName = escapeHtml(r.nickname || r.username);
                    
                    if (!r.anonymous && r.user_id) {
                        try {
                            const user = await supabase.from('users').select('pfp, username').eq('id', r.user_id).single().execute();
                            if (user) {
                                userPfp = user.pfp ? `<img src="${user.pfp}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§';
                                displayName = r.nickname ? escapeHtml(r.nickname) : escapeHtml(user.username);
                            }
                        } catch (e) {
                            // Use default if user lookup fails
                        }
                    }

                    return `
                        <div class="comment" style="background: var(--bg-primary); padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: start; gap: 10px;">
                                <div style="width: 30px; height: 30px; min-width: 30px; border-radius: 50%; background: var(--bg-tertiary); overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                    ${userPfp}
                                </div>
                                <div style="flex: 1;">
                                    <div class="comment-author" style="font-size: 0.9em;">${displayName}</div>
                                    <div style="font-size: 0.9em; margin-top: 3px;">${escapeHtml(r.text)}</div>
                                    <div style="margin-top: 5px; font-size: 0.75em; color: var(--text-secondary);">
                                        <span>${formatTimeAgo(r.created_at)}</span>
                                        ${(isAdmin || isOwner || r.user_id === currentUser.id) ? `<span style="margin-left: 10px; cursor: pointer; color: var(--error);" onclick="deleteReply(${r.id}, ${commentId})">Delete</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }));

                repliesDiv.innerHTML = repliesHtml.join('');
            } catch (error) {
                console.error('Load replies error:', error);
            }
        }

        function replyToComment(commentId, replyToName, contentType, contentId) {
            const repliesDiv = document.getElementById(`replies-${commentId}`);
            
            // Check if reply form already exists
            if (document.getElementById(`reply-form-${commentId}`)) {
                return;
            }

            const replyForm = `
                <div id="reply-form-${commentId}" style="margin-top: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <div style="margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9em;">Replying to ${escapeHtml(replyToName)}</div>
                    <input type="text" id="reply-nickname-${commentId}" placeholder="Nickname (optional)" style="width: 100%; padding: 6px; margin-bottom: 8px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.9em;">
                    <textarea id="reply-text-${commentId}" placeholder="Write your reply..." rows="2" style="width: 100%; padding: 8px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 6px; color: var(--text-primary); margin-bottom: 8px; font-size: 0.9em;"></textarea>
                    <div class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="reply-anonymous-${commentId}">
                        <label for="reply-anonymous-${commentId}" style="font-size: 0.9em;">Post anonymously</label>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-small" onclick="submitReply(${commentId}, '${contentType}', ${contentId})">Post Reply</button>
                        <button class="btn btn-small btn-secondary" onclick="cancelReply(${commentId})">Cancel</button>
                    </div>
                </div>
            `;
            
            repliesDiv.insertAdjacentHTML('beforeend', replyForm);
        }

        async function submitReply(commentId, contentType, contentId) {
            const nickname = document.getElementById(`reply-nickname-${commentId}`).value.trim();
            const text = document.getElementById(`reply-text-${commentId}`).value.trim();
            const anonymous = document.getElementById(`reply-anonymous-${commentId}`).checked;

            if (!text) {
                alert('Please write a reply');
                return;
            }

            if (containsRestrictedWords(text) || containsRestrictedWords(nickname)) {
                alert('Reply contains restricted words');
                return;
            }

            try {
                await supabase.from('replies').insert({
                    comment_id: commentId,
                    user_id: currentUser.id,
                    username: currentUser.username,
                    nickname: nickname || null,
                    text: text,
                    anonymous: anonymous,
                    created_at: new Date().toISOString()
                }).select().execute();

                cancelReply(commentId);
                await loadReplies(commentId);
            } catch (error) {
                console.error('Submit reply error:', error);
                alert('Error posting reply');
            }
        }

        function cancelReply(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.remove();
            }
        }

        async function deleteComment(commentId, contentType, contentId) {
            if (!confirm('Delete this comment?')) return;

            try {
                await supabase.from('comments').delete().eq('id', commentId).execute();
                showComments(contentType, contentId);
                showComments(contentType, contentId); // Toggle twice to refresh
            } catch (error) {
                console.error('Delete comment error:', error);
            }
        }

        async function deleteReply(replyId, commentId) {
            if (!confirm('Delete this reply?')) return;

            try {
                await supabase.from('replies').delete().eq('id', replyId).execute();
                await loadReplies(commentId);
            } catch (error) {
                console.error('Delete reply error:', error);
            }
        }

        async function postComment(type, id) {
            const nickname = document.getElementById(`comment-nickname-${type}-${id}`).value.trim();
            const text = document.getElementById(`comment-text-${type}-${id}`).value.trim();
            const anonymous = document.getElementById(`comment-anonymous-${type}-${id}`).checked;

            if (!text) return;

            if (containsRestrictedWords(text) || containsRestrictedWords(nickname)) {
                alert('Comment contains restricted words');
                return;
            }

            try {
                await supabase.from('comments').insert({
                    content_type: type,
                    content_id: id,
                    user_id: currentUser.id,
                    username: currentUser.username,
                    nickname: nickname || null,
                    text: text,
                    anonymous: anonymous,
                    created_at: new Date().toISOString()
                }).select().execute();

                showComments(type, id);
            } catch (error) {
                console.error('Post comment error:', error);
            }
        }

        // ==========================================
        // QUIZZES
        // ==========================================

        function addQuizOption() {
            const container = document.getElementById('quiz-options');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'quiz-option-input';
            input.placeholder = `Option ${container.children.length + 1}`;
            input.style.cssText = 'width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);';
            container.appendChild(input);
            updateQuizCorrectOptions();
        }

        function updateQuizCorrectOptions() {
            const select = document.getElementById('quiz-correct');
            const inputs = document.querySelectorAll('.quiz-option-input');
            select.innerHTML = '<option value="">Select correct answer</option>';
            inputs.forEach((input, i) => {
                select.innerHTML += `<option value="${i}">Option ${i + 1}</option>`;
            });
        }

        document.getElementById('quiz-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('quiz-title').value.trim();
            const question = document.getElementById('quiz-question').value.trim();
            const imageFile = document.getElementById('quiz-image').files[0];
            const options = Array.from(document.querySelectorAll('.quiz-option-input')).map(i => i.value.trim());
            const correctIndex = parseInt(document.getElementById('quiz-correct').value);
            const anonymous = document.getElementById('quiz-anonymous').checked;

            if (containsRestrictedWords(title) || containsRestrictedWords(question)) {
                showAlert('quiz-alert', '‚ùå Content contains restricted words', 'error');
                return;
            }

            try {
                const imageData = imageFile ? await uploadImage(imageFile) : null;

                await supabase.from('quizzes').insert({
                    user_id: currentUser.id,
                    username: anonymous ? null : currentUser.username,
                    user_pfp: anonymous ? null : currentUser.pfp,
                    user_rank: anonymous ? null : currentUser.rank,
                    title: title,
                    question: question,
                    image: imageData,
                    options: options,
                    correct_answer: correctIndex,
                    attempts: 0,
                    correct_attempts: 0,
                    likes: 0,
                    reports: 0,
                    created_at: new Date().toISOString()
                }).select().execute();

                showAlert('quiz-alert', '‚úÖ Quiz created!', 'success');
                document.getElementById('quiz-form').reset();
                document.getElementById('quiz-options').innerHTML = '<input type="text" class="quiz-option-input" placeholder="Option 1" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);"><input type="text" class="quiz-option-input" placeholder="Option 2" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);">';
                loadQuizzes();
            } catch (error) {
                console.error('Create quiz error:', error);
                showAlert('quiz-alert', '‚ùå Error creating quiz', 'error');
            }
        });

        async function loadQuizzes() {
            const listDiv = document.getElementById('quizzes-list');
            listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div>Loading...</div>';

            try {
                const quizzes = await supabase.from('quizzes').select('*').order('created_at', { ascending: false }).execute();
                
                if (quizzes.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üß†</div><div>No quizzes yet</div></div>';
                    return;
                }

                listDiv.innerHTML = quizzes.map(quiz => renderQuiz(quiz)).join('');
                updateFollowButtons();
            } catch (error) {
                console.error('Load quizzes error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">‚ùå Error loading quizzes</div>';
            }
        }

        function renderQuiz(quiz) {
            const answered = hasAnswered(quiz.id);
            const liked = isLiked('quiz', quiz.id);
            const favorited = isFavorited('quiz', quiz.id);
            const anonymous = !quiz.username;
            const isOwnerPost = quiz.user_rank === 'Owner';
            const canFollow = !anonymous && quiz.user_id !== currentUser.id;
            const successRate = quiz.attempts > 0 ? Math.round((quiz.correct_attempts / quiz.attempts) * 100) : 0;

            // Determine card class based on rank
            let cardClass = '';
            if (isOwnerPost) cardClass = 'owner-post';
            else if (quiz.user_rank === 'Rank 1') cardClass = 'rank1-post';
            else if (quiz.user_rank === 'Rank 2: Idiot') cardClass = 'rank2-post';
            else if (quiz.user_rank === 'Rank 3: Smart person') cardClass = 'rank3-post';
            else if (quiz.user_rank === 'Potential Terrorist') cardClass = 'terrorist-post';

            const processedQuestion = processMentions(quiz.question);

            return `
                <div class="card ${cardClass}">
                    <div class="card-header">
                        <div class="card-author">
                            <div class="author-pfp">
                                ${anonymous ? 'üë§' : (quiz.user_pfp ? `<img src="${quiz.user_pfp}">` : 'üë§')}
                            </div>
                            <div class="author-info">
                                <div class="author-name" style="${!anonymous ? 'cursor: pointer; text-decoration: underline;' : ''}" ${!anonymous ? `onclick="viewUserProfile(${quiz.user_id})"` : ''}>
                                    ${anonymous ? 'Anonymous' : escapeHtml(quiz.username)}
                                    ${isOwnerPost ? '<span class="owner-badge">üëë OWNER</span>' : ''}
                                </div>
                                <div class="author-rank">${anonymous ? '' : quiz.user_rank}</div>
                            </div>
                        </div>
                        ${canFollow ? `<button class="follow-btn" onclick="toggleFollow(${quiz.user_id})" id="follow-btn-${quiz.user_id}">Follow</button>` : ''}
                    </div>
                    <div class="card-title">${escapeHtml(quiz.title)}</div>
                    ${quiz.image ? `<img src="${quiz.image}" class="card-image">` : ''}
                    <div class="card-text"><strong>Question:</strong> ${processedQuestion}</div>
                    <div class="card-meta">
                        <span>üìä ${quiz.attempts} attempts</span>
                        <span>‚úÖ ${successRate}% success</span>
                        <span>üëç ${quiz.likes}</span>
                        <span>üïí ${formatTimeAgo(quiz.created_at)}</span>
                    </div>
                    ${answered ? '<div class="alert alert-info">You already answered this quiz</div>' : `
                        <div class="quiz-options" id="quiz-options-${quiz.id}">
                            ${quiz.options.map((opt, i) => `
                                <div class="quiz-option" onclick="selectQuizOption(${quiz.id}, ${i})">
                                    <input type="radio" name="quiz-${quiz.id}" value="${i}" id="quiz-${quiz.id}-${i}">
                                    <label for="quiz-${quiz.id}-${i}">${escapeHtml(opt)}</label>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="submitQuiz(${quiz.id})">Submit Answer</button>
                    `}
                    <div id="quiz-result-${quiz.id}"></div>
                    <div class="card-actions" style="margin-top: 15px;">
                        <button class="action-btn ${liked ? 'active' : ''}" onclick="toggleLike('quiz', ${quiz.id})">
                            üëç Like
                        </button>
                        <button class="action-btn ${favorited ? 'active' : ''}" onclick="toggleFavorite('quiz', ${quiz.id})">
                            ‚≠ê Favorite
                        </button>
                        <button class="action-btn" onclick="reportContent('quiz', ${quiz.id})">
                            üö© Report
                        </button>
                        <button class="action-btn" onclick="showComments('quiz', ${quiz.id})">
                            üí¨ Comments
                        </button>
                        ${(isAdmin || isOwner || quiz.user_id === currentUser.id) ? `<button class="action-btn" style="background: var(--error); color: white;" onclick="deleteOwnPost('quiz', ${quiz.id}, ${quiz.user_id})">üóëÔ∏è Delete</button>` : ''}
                    </div>
                    <div id="comments-quiz-${quiz.id}" class="comments-section hidden"></div>
                </div>
            `;
        }

        function selectQuizOption(quizId, optionIndex) {
            document.getElementById(`quiz-${quizId}-${optionIndex}`).checked = true;
        }

        async function submitQuiz(quizId) {
            const selected = document.querySelector(`input[name="quiz-${quizId}"]:checked`);
            if (!selected) {
                alert('Please select an answer');
                return;
            }

            const selectedIndex = parseInt(selected.value);

            try {
                const quiz = await supabase.from('quizzes').select('*').eq('id', quizId).single().execute();
                const isCorrect = selectedIndex === quiz.correct_answer;

                await supabase.from('quizzes').update({
                    attempts: quiz.attempts + 1,
                    correct_attempts: quiz.correct_attempts + (isCorrect ? 1 : 0)
                }).eq('id', quizId).execute();

                if (isCorrect) {
                    await supabase.from('users').update({
                        quiz_score: currentUser.quiz_score + 1
                    }).eq('id', currentUser.id).execute();
                    currentUser.quiz_score++;
                }

                markAsAnswered(quizId);

                const resultDiv = document.getElementById(`quiz-result-${quizId}`);
                if (isCorrect) {
                    resultDiv.innerHTML = '<div class="alert alert-success">üéâ Correct! +1 point</div>';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">‚ùå Wrong! Correct: ${escapeHtml(quiz.options[quiz.correct_answer])}</div>`;
                }

                loadQuizzes();
            } catch (error) {
                console.error('Submit quiz error:', error);
            }
        }

        function hasAnswered(quizId) {
            const answered = JSON.parse(localStorage.getItem('answeredQuizzes') || '[]');
            return answered.includes(quizId);
        }

        function markAsAnswered(quizId) {
            const answered = JSON.parse(localStorage.getItem('answeredQuizzes') || '[]');
            answered.push(quizId);
            localStorage.setItem('answeredQuizzes', JSON.stringify(answered));
        }

        // ==========================================
        // POLLS
        // ==========================================

        function addPollOption() {
            const container = document.getElementById('poll-options');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'poll-option-input';
            input.placeholder = `Option ${container.children.length + 1}`;
            input.style.cssText = 'width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);';
            container.appendChild(input);
        }

        document.getElementById('poll-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const question = document.getElementById('poll-question').value.trim();
            const options = Array.from(document.querySelectorAll('.poll-option-input')).map(i => i.value.trim());
            const anonymous = document.getElementById('poll-anonymous').checked;

            if (containsRestrictedWords(question)) {
                showAlert('poll-alert', '‚ùå Content contains restricted words', 'error');
                return;
            }

            try {
                const votes = options.map(() => 0);

                await supabase.from('polls').insert({
                    user_id: currentUser.id,
                    username: anonymous ? null : currentUser.username,
                    user_pfp: anonymous ? null : currentUser.pfp,
                    user_rank: anonymous ? null : currentUser.rank,
                    question: question,
                    options: options,
                    votes: votes,
                    likes: 0,
                    reports: 0,
                    created_at: new Date().toISOString()
                }).select().execute();

                showAlert('poll-alert', '‚úÖ Poll created!', 'success');
                document.getElementById('poll-form').reset();
                document.getElementById('poll-options').innerHTML = '<input type="text" class="poll-option-input" placeholder="Option 1" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);"><input type="text" class="poll-option-input" placeholder="Option 2" required style="width: 100%; margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary);">';
                loadPolls();
            } catch (error) {
                console.error('Create poll error:', error);
                showAlert('poll-alert', '‚ùå Error creating poll', 'error');
            }
        });

        async function loadPolls() {
            const listDiv = document.getElementById('polls-list');
            listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div>Loading...</div>';

            try {
                const polls = await supabase.from('polls').select('*').order('created_at', { ascending: false }).execute();
                
                if (polls.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div>No polls yet</div></div>';
                    return;
                }

                listDiv.innerHTML = polls.map(poll => renderPoll(poll)).join('');
                updateFollowButtons();
            } catch (error) {
                console.error('Load polls error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">‚ùå Error loading polls</div>';
            }
        }

        function renderPoll(poll) {
            const voted = hasVoted(poll.id);
            const liked = isLiked('poll', poll.id);
            const favorited = isFavorited('poll', poll.id);
            const anonymous = !poll.username;
            const isOwnerPost = poll.user_rank === 'Owner';
            const canFollow = !anonymous && poll.user_id !== currentUser.id;
            const totalVotes = poll.votes.reduce((a, b) => a + b, 0);

            // Determine card class based on rank
            let cardClass = '';
            if (isOwnerPost) cardClass = 'owner-post';
            else if (poll.user_rank === 'Rank 1') cardClass = 'rank1-post';
            else if (poll.user_rank === 'Rank 2: Idiot') cardClass = 'rank2-post';
            else if (poll.user_rank === 'Rank 3: Smart person') cardClass = 'rank3-post';
            else if (poll.user_rank === 'Potential Terrorist') cardClass = 'terrorist-post';

            const processedQuestion = processMentions(poll.question);

            return `
                <div class="card ${cardClass}">
                    <div class="card-header">
                        <div class="card-author">
                            <div class="author-pfp">
                                ${anonymous ? 'üë§' : (poll.user_pfp ? `<img src="${poll.user_pfp}">` : 'üë§')}
                            </div>
                            <div class="author-info">
                                <div class="author-name" style="${!anonymous ? 'cursor: pointer; text-decoration: underline;' : ''}" ${!anonymous ? `onclick="viewUserProfile(${poll.user_id})"` : ''}>
                                    ${anonymous ? 'Anonymous' : escapeHtml(poll.username)}
                                    ${isOwnerPost ? '<span class="owner-badge">üëë OWNER</span>' : ''}
                                </div>
                                <div class="author-rank">${anonymous ? '' : poll.user_rank}</div>
                            </div>
                        </div>
                        ${canFollow ? `<button class="follow-btn" onclick="toggleFollow(${poll.user_id})" id="follow-btn-${poll.user_id}">Follow</button>` : ''}
                    </div>
                    <div class="card-title">${processedQuestion}</div>
                    <div class="card-meta">
                        <span>üó≥Ô∏è ${totalVotes} votes</span>
                        <span>üëç ${poll.likes}</span>
                        <span>üïí ${formatTimeAgo(poll.created_at)}</span>
                    </div>
                    ${voted ? poll.options.map((opt, i) => {
                        const votes = poll.votes[i];
                        const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                        return `
                            <div class="poll-option">
                                <div class="poll-bar" style="width: ${percentage}%"></div>
                                <div class="poll-content">
                                    <span>${escapeHtml(opt)}</span>
                                    <span>${percentage}% (${votes})</span>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        ${poll.options.map((opt, i) => `
                            <div class="poll-option" onclick="votePoll(${poll.id}, ${i})">
                                ${escapeHtml(opt)}
                            </div>
                        `).join('')}
                    `}
                    <div class="card-actions" style="margin-top: 15px;">
                        <button class="action-btn ${liked ? 'active' : ''}" onclick="toggleLike('poll', ${poll.id})">
                            üëç Like
                        </button>
                        <button class="action-btn ${favorited ? 'active' : ''}" onclick="toggleFavorite('poll', ${poll.id})">
                            ‚≠ê Favorite
                        </button>
                        <button class="action-btn" onclick="reportContent('poll', ${poll.id})">
                            üö© Report
                        </button>
                        <button class="action-btn" onclick="showComments('poll', ${poll.id})">
                            üí¨ Comments
                        </button>
                        ${(isAdmin || isOwner || poll.user_id === currentUser.id) ? `<button class="action-btn" style="background: var(--error); color: white;" onclick="deleteOwnPost('poll', ${poll.id}, ${poll.user_id})">üóëÔ∏è Delete</button>` : ''}
                    </div>
                    <div id="comments-poll-${poll.id}" class="comments-section hidden"></div>
                </div>
            `;
        }

        async function votePoll(pollId, optionIndex) {
            try {
                const poll = await supabase.from('polls').select('*').eq('id', pollId).single().execute();
                const votes = [...poll.votes];
                votes[optionIndex]++;

                await supabase.from('polls').update({ votes }).eq('id', pollId).execute();

                markAsVoted(pollId);
                loadPolls();
            } catch (error) {
                console.error('Vote poll error:', error);
            }
        }

        function hasVoted(pollId) {
            const voted = JSON.parse(localStorage.getItem('votedPolls') || '[]');
            return voted.includes(pollId);
        }

        function markAsVoted(pollId) {
            const voted = JSON.parse(localStorage.getItem('votedPolls') || '[]');
            voted.push(pollId);
            localStorage.setItem('votedPolls', JSON.stringify(voted));
        }

        // ==========================================
        // FAVORITES
        // ==========================================

        async function loadFavorites() {
            const listDiv = document.getElementById('favorites-list');
            const favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
            const favKeys = Object.keys(favorites).filter(k => favorites[k]);

            if (favKeys.length === 0) {
                listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚≠ê</div><div>No favorites yet</div></div>';
                return;
            }

            listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div>Loading...</div>';

            try {
                let html = '';

                for (const key of favKeys) {
                    const [type, id] = key.split('_');
                    const table = type === 'review' ? 'reviews' : type === 'quiz' ? 'quizzes' : 'polls';
                    const item = await supabase.from(table).select('*').eq('id', id).single().execute();
                    
                    if (item) {
                        if (type === 'review') html += renderReview(item);
                        else if (type === 'quiz') html += renderQuiz(item);
                        else if (type === 'poll') html += renderPoll(item);
                    }
                }

                listDiv.innerHTML = html || '<div class="empty-state"><div class="empty-icon">‚≠ê</div><div>No favorites found</div></div>';
            } catch (error) {
                console.error('Load favorites error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">‚ùå Error loading favorites</div>';
            }
        }

        // ==========================================
        // LEADERBOARD
        // ==========================================

        async function loadLeaderboard() {
            const listDiv = document.getElementById('leaderboard-list');
            listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div>Loading...</div>';

            try {
                const users = await supabase.from('users').select('*').order('quiz_score', { ascending: false }).execute();
                
                if (users.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><div>No data yet</div></div>';
                    return;
                }

                listDiv.innerHTML = users.map((user, index) => `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">#${index + 1}</div>
                        <div class="leaderboard-pfp">
                            ${user.pfp ? `<img src="${user.pfp}">` : 'üë§'}
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${escapeHtml(user.username)}</div>
                            <div class="leaderboard-score">${user.quiz_score} correct answers</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load leaderboard error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">‚ùå Error loading leaderboard</div>';
            }
        }

        // ==========================================
        // SEARCH
        // ==========================================

        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            document.querySelectorAll('.card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(query) ? 'block' : 'none';
            });
        });

        // ==========================================
        // FOLLOW SYSTEM
        // ==========================================

        async function toggleFollow(userId) {
            try {
                const existing = await supabase.from('follows')
                    .select('*')
                    .eq('follower_id', currentUser.id)
                    .eq('following_id', userId)
                    .single()
                    .execute();

                if (existing) {
                    // Unfollow
                    await supabase.from('follows')
                        .delete()
                        .eq('follower_id', currentUser.id)
                        .eq('following_id', userId)
                        .execute();
                } else {
                    // Follow
                    await supabase.from('follows').insert({
                        follower_id: currentUser.id,
                        following_id: userId,
                        created_at: new Date().toISOString()
                    }).select().execute();
                }

                updateFollowButtons();
            } catch (error) {
                console.error('Follow error:', error);
            }
        }

        async function updateFollowButtons() {
            try {
                const follows = await supabase.from('follows')
                    .select('following_id')
                    .eq('follower_id', currentUser.id)
                    .execute();

                const followingIds = follows.map(f => f.following_id);

                document.querySelectorAll('.follow-btn').forEach(btn => {
                    const onclickAttr = btn.getAttribute('onclick');
                    if (!onclickAttr) return;
                    
                    const match = onclickAttr.match(/\d+/);
                    if (!match) return;
                    
                    const userId = parseInt(match[0]);
                    if (followingIds.includes(userId)) {
                        btn.textContent = 'Following';
                        btn.classList.add('following');
                    } else {
                        btn.textContent = 'Follow';
                        btn.classList.remove('following');
                    }
                });
            } catch (error) {
                console.error('Update follow buttons error:', error);
            }
        }

        async function loadFollowsLeaderboard() {
            const listDiv = document.getElementById('follows-leaderboard');
            listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div>Loading...</div>';

            try {
                const follows = await supabase.from('follows').select('following_id').execute();
                const followerCounts = {};
                follows.forEach(f => {
                    followerCounts[f.following_id] = (followerCounts[f.following_id] || 0) + 1;
                });

                const sorted = Object.entries(followerCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 20);

                if (sorted.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div>No one has followers yet</div></div>';
                    return;
                }

                const users = await supabase.from('users').select('*').execute();
                const userMap = {};
                users.forEach(u => userMap[u.id] = u);

                listDiv.innerHTML = sorted.map(([userId, count], index) => {
                    const user = userMap[userId];
                    if (!user) return '';
                    return `
                        <div class="leaderboard-item">
                            <div class="leaderboard-rank">#${index + 1}</div>
                            <div class="leaderboard-pfp">
                                ${user.pfp ? `<img src="${user.pfp}">` : 'üë§'}
                            </div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${escapeHtml(user.username)}</div>
                                <div class="leaderboard-score">${count} followers</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Load follows leaderboard error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">‚ùå Error loading leaderboard</div>';
            }
        }

        // ==========================================
        // PROFILE
        // ==========================================

        let viewingUserId = null;

        async function viewUserProfile(userId) {
            if (userId === currentUser.id) {
                // Viewing own profile
                backToMyProfile();
                return;
            }

            viewingUserId = userId;
            document.getElementById('my-profile-view').style.display = 'none';
            document.getElementById('user-profile-view').style.display = 'block';

            try {
                const user = await supabase.from('users').select('*').eq('id', userId).single().execute();
                
                // Get follower/following counts
                const followers = await supabase.from('follows').select('*').eq('following_id', userId).execute();
                const following = await supabase.from('follows').select('*').eq('follower_id', userId).execute();
                
                // Count posts
                const reviews = await supabase.from('reviews').select('id').eq('user_id', userId).execute();
                const quizzes = await supabase.from('quizzes').select('id').eq('user_id', userId).execute();
                const polls = await supabase.from('polls').select('id').eq('user_id', userId).execute();
                const totalPosts = reviews.length + quizzes.length + polls.length;

                // Update display
                document.getElementById('view-user-username').textContent = user.username;
                document.getElementById('view-user-rank').textContent = user.rank;
                document.getElementById('view-user-followers').textContent = followers.length;
                document.getElementById('view-user-following').textContent = following.length;
                document.getElementById('view-user-posts').textContent = totalPosts;
                document.getElementById('view-user-description').textContent = user.description || 'No bio yet';

                if (user.pfp) {
                    document.getElementById('view-user-pfp').innerHTML = `<img src="${user.pfp}">`;
                } else {
                    document.getElementById('view-user-pfp').innerHTML = 'üë§';
                }

                // Check if following
                const isFollowing = await supabase.from('follows')
                    .select('*')
                    .eq('follower_id', currentUser.id)
                    .eq('following_id', userId)
                    .single()
                    .execute();

                const followBtn = document.getElementById('view-user-follow-btn');
                if (isFollowing) {
                    followBtn.textContent = 'Following';
                    followBtn.classList.add('following');
                } else {
                    followBtn.textContent = 'Follow';
                    followBtn.classList.remove('following');
                }
            } catch (error) {
                console.error('View profile error:', error);
            }
        }

        async function toggleFollowFromProfile() {
            if (!viewingUserId) return;
            await toggleFollow(viewingUserId);
            await viewUserProfile(viewingUserId); // Refresh
        }

        function backToMyProfile() {
            viewingUserId = null;
            document.getElementById('user-profile-view').style.display = 'none';
            document.getElementById('my-profile-view').style.display = 'block';
            loadProfile();
        }

        async function loadProfile() {
            try {
                // Get follower/following counts
                const followers = await supabase.from('follows')
                    .select('*')
                    .eq('following_id', currentUser.id)
                    .execute();

                const following = await supabase.from('follows')
                    .select('*')
                    .eq('follower_id', currentUser.id)
                    .execute();

                // Count posts
                const reviews = await supabase.from('reviews').select('id').eq('user_id', currentUser.id).execute();
                const quizzes = await supabase.from('quizzes').select('id').eq('user_id', currentUser.id).execute();
                const polls = await supabase.from('polls').select('id').eq('user_id', currentUser.id).execute();
                const totalPosts = reviews.length + quizzes.length + polls.length;

                // Update display
                document.getElementById('profile-username-display').textContent = currentUser.username;
                document.getElementById('profile-rank-display').textContent = currentUser.rank;
                document.getElementById('profile-followers').textContent = followers.length;
                document.getElementById('profile-following').textContent = following.length;
                document.getElementById('profile-posts').textContent = totalPosts;
                document.getElementById('profile-description').value = currentUser.description || '';

                if (currentUser.pfp) {
                    document.getElementById('profile-pfp-display').innerHTML = `<img src="${currentUser.pfp}">`;
                }

                // Load following list
                await loadFollowingList();
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        async function loadFollowingList() {
            const listDiv = document.getElementById('following-list');
            listDiv.innerHTML = '<div style="color: var(--text-secondary); padding: 10px;">Loading...</div>';

            try {
                const follows = await supabase.from('follows')
                    .select('following_id')
                    .eq('follower_id', currentUser.id)
                    .execute();

                if (follows.length === 0) {
                    listDiv.innerHTML = '<div style="color: var(--text-secondary); padding: 10px;">You\'re not following anyone yet</div>';
                    return;
                }

                const userIds = follows.map(f => f.following_id);
                const users = await supabase.from('users').select('*').execute();
                const followingUsers = users.filter(u => userIds.includes(u.id));

                listDiv.innerHTML = followingUsers.map(user => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--bg-tertiary); overflow: hidden; cursor: pointer;" onclick="viewUserProfile(${user.id})">
                            ${user.pfp ? `<img src="${user.pfp}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
                        </div>
                        <div style="flex: 1; cursor: pointer;" onclick="viewUserProfile(${user.id})">
                            <div style="font-weight: 600;">${escapeHtml(user.username)}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${user.rank}</div>
                        </div>
                        <button class="btn btn-small btn-secondary" onclick="unfollowUser(${user.id})">Unfollow</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load following list error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">Error loading following list</div>';
            }
        }

        async function unfollowUser(userId) {
            if (!confirm('Unfollow this user?')) return;

            try {
                await supabase.from('follows')
                    .delete()
                    .eq('follower_id', currentUser.id)
                    .eq('following_id', userId)
                    .execute();

                await loadFollowingList();
                await loadProfile(); // Refresh stats
            } catch (error) {
                console.error('Unfollow error:', error);
            }
        }

        async function deleteOwnPost(type, id, postOwnerId) {
            // Check if user owns this post or is admin/owner
            if (postOwnerId !== currentUser.id && !isAdmin && !isOwner) {
                alert('You can only delete your own posts!');
                return;
            }

            if (!confirm('Delete this post?')) return;

            try {
                const table = type === 'review' ? 'reviews' : type === 'quiz' ? 'quizzes' : 'polls';
                await supabase.from(table).delete().eq('id', id).execute();

                if (type === 'review') loadReviews();
                else if (type === 'quiz') loadQuizzes();
                else if (type === 'poll') loadPolls();

                alert('‚úÖ Post deleted');
            } catch (error) {
                console.error('Delete post error:', error);
                alert('‚ùå Error deleting post');
            }
        }

        document.getElementById('profile-pfp-change').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const dataUrl = await uploadImage(file);
                document.getElementById('profile-pfp-display').innerHTML = `<img src="${dataUrl}">`;
            }
        });

        async function updateProfile() {
            const description = document.getElementById('profile-description').value;
            const pfpFile = document.getElementById('profile-pfp-change').files[0];

            try {
                const updates = { description };

                if (pfpFile) {
                    updates.pfp = await uploadImage(pfpFile);
                }

                await supabase.from('users').update(updates).eq('id', currentUser.id).execute();

                // Update current user
                currentUser.description = description;
                if (updates.pfp) {
                    currentUser.pfp = updates.pfp;
                    document.getElementById('header-pfp').innerHTML = `<img src="${updates.pfp}">`;
                }

                showAlert('profile-alert', '‚úÖ Profile updated!', 'success');
            } catch (error) {
                console.error('Update profile error:', error);
                showAlert('profile-alert', '‚ùå Error updating profile', 'error');
            }
        }

        // ==========================================
        // RANDOM POST
        // ==========================================

        async function showRandomPost() {
            try {
                const reviews = await supabase.from('reviews').select('*').execute();
                const quizzes = await supabase.from('quizzes').select('*').execute();
                const polls = await supabase.from('polls').select('*').execute();

                const allContent = [
                    ...reviews.map(r => ({ type: 'reviews', data: r })),
                    ...quizzes.map(q => ({ type: 'quizzes', data: q })),
                    ...polls.map(p => ({ type: 'polls', data: p }))
                ];

                if (allContent.length === 0) {
                    alert('No content available yet!');
                    return;
                }

                const random = allContent[Math.floor(Math.random() * allContent.length)];

                // Find and click the appropriate tab button
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.includes('Messages') && random.type === 'reviews') {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('Quizzes') && random.type === 'quizzes') {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('Polls') && random.type === 'polls') {
                        btn.classList.add('active');
                    }
                });

                // Show the appropriate tab
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${random.type}-tab`).classList.add('active');

                // Load the content
                if (random.type === 'reviews') await loadReviews();
                else if (random.type === 'quizzes') await loadQuizzes();
                else if (random.type === 'polls') await loadPolls();

                // Scroll to top after a brief delay
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 300);
            } catch (error) {
                console.error('Random post error:', error);
                alert('Error loading random post');
            }
        }

        // ==========================================
        // REPORTED CONTENT (Owner Only)
        // ==========================================

        async function loadReported() {
            if (!isOwner) return;

            const listDiv = document.getElementById('reported-list');
            listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div>Loading...</div>';

            try {
                const reviews = await supabase.from('reviews').select('*').execute();
                const quizzes = await supabase.from('quizzes').select('*').execute();
                const polls = await supabase.from('polls').select('*').execute();

                const reported = [
                    ...reviews.filter(r => r.reports > 0).map(r => ({ ...r, type: 'review' })),
                    ...quizzes.filter(q => q.reports > 0).map(q => ({ ...q, type: 'quiz' })),
                    ...polls.filter(p => p.reports > 0).map(p => ({ ...p, type: 'poll' }))
                ].sort((a, b) => b.reports - a.reports);

                if (reported.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üö©</div><div>No reported content</div></div>';
                    return;
                }

                listDiv.innerHTML = reported.map(item => {
                    if (item.type === 'review') return renderReview(item);
                    if (item.type === 'quiz') return renderQuiz(item);
                    return renderPoll(item);
                }).join('');
            } catch (error) {
                console.error('Load reported error:', error);
                listDiv.innerHTML = '<div class="alert alert-error">‚ùå Error loading reported content</div>';
            }
        }

        // ==========================================
        // SETTINGS
        // ==========================================

        function loadSettings() {
            document.getElementById('settings-username').value = currentUser.username;
            document.getElementById('settings-rank').value = currentUser.rank;
            document.getElementById('settings-score').value = currentUser.quiz_score;
            
            // Set theme select
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            document.getElementById('theme-select').value = currentTheme;
            
            // Show admin panel if user is admin
            if (isAdmin) {
                document.getElementById('admin-panel').style.display = 'block';
                loadAdminList();
            } else {
                document.getElementById('admin-panel').style.display = 'none';
            }
        }

        function changeTheme() {
            const theme = document.getElementById('theme-select').value;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        async function changePassword() {
            const newPassword = document.getElementById('settings-new-password').value;
            
            if (!newPassword) {
                alert('Please enter a new password');
                return;
            }

            if (newPassword.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            try {
                await supabase.from('users').update({ password: newPassword }).eq('id', currentUser.id).execute();
                currentUser.password = newPassword;
                document.getElementById('settings-new-password').value = '';
                alert('‚úÖ Password updated successfully!');
            } catch (error) {
                console.error('Password change error:', error);
                alert('‚ùå Error updating password');
            }
        }

        async function deleteAccount() {
            const confirm1 = confirm('‚ö†Ô∏è Are you sure you want to delete your account? This cannot be undone!');
            if (!confirm1) return;
            
            const confirm2 = confirm('‚ö†Ô∏è FINAL WARNING: All your posts, quizzes, polls, and comments will be deleted. Are you absolutely sure?');
            if (!confirm2) return;

            try {
                await supabase.from('users').delete().eq('id', currentUser.id).execute();
                localStorage.removeItem('currentUserId');
                alert('Account deleted. Goodbye! üò¢');
                window.location.reload();
            } catch (error) {
                console.error('Delete account error:', error);
                alert('‚ùå Error deleting account');
            }
        }

        // ==========================================
        // ADMIN FUNCTIONS
        // ==========================================

        async function loadAdminList() {
            try {
                const admins = await supabase.from('admins').select('user_id').execute();
                const adminIds = admins.map(a => a.user_id);
                
                if (adminIds.length === 0) {
                    document.getElementById('admin-list').innerHTML = '<div style="color: var(--text-secondary); padding: 10px;">No admins yet</div>';
                    return;
                }

                const users = await supabase.from('users').select('*').execute();
                const adminUsers = users.filter(u => adminIds.includes(u.id));

                document.getElementById('admin-list').innerHTML = adminUsers.map(user => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background: var(--bg-tertiary); overflow: hidden;">
                            ${user.pfp ? `<img src="${user.pfp}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${escapeHtml(user.username)}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Admin</div>
                        </div>
                        ${user.id !== currentUser.id ? `<button class="btn btn-small" style="background: var(--error);" onclick="removeAdmin(${user.id})">Remove</button>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load admin list error:', error);
            }
        }

        async function addAdmin() {
            const username = document.getElementById('admin-username-input').value.trim();
            
            if (!username) {
                showAlert('admin-alert', 'Please enter a username', 'error');
                return;
            }

            try {
                // Find user by username
                const user = await supabase.from('users').select('*').eq('username', username).single().execute();
                
                if (!user) {
                    showAlert('admin-alert', '‚ùå User not found', 'error');
                    return;
                }

                // Check if already admin
                const existing = await supabase.from('admins').select('*').eq('user_id', user.id).single().execute();
                if (existing) {
                    showAlert('admin-alert', '‚ùå User is already an admin', 'error');
                    return;
                }

                // Add to admins table
                await supabase.from('admins').insert({
                    user_id: user.id,
                    created_at: new Date().toISOString()
                }).select().execute();

                // Update user rank
                await supabase.from('users').update({ rank: 'Admin' }).eq('id', user.id).execute();

                showAlert('admin-alert', `‚úÖ ${username} is now an admin!`, 'success');
                document.getElementById('admin-username-input').value = '';
                loadAdminList();
            } catch (error) {
                console.error('Add admin error:', error);
                showAlert('admin-alert', '‚ùå Error adding admin', 'error');
            }
        }

        async function removeAdmin(userId) {
            if (!confirm('Remove this user from admins?')) return;

            try {
                await supabase.from('admins').delete().eq('user_id', userId).execute();
                await supabase.from('users').update({ rank: 'Member' }).eq('id', userId).execute();
                
                showAlert('admin-alert', '‚úÖ Admin removed', 'success');
                loadAdminList();
            } catch (error) {
                console.error('Remove admin error:', error);
                showAlert('admin-alert', '‚ùå Error removing admin', 'error');
            }
        }

        async function assignRank() {
            const username = document.getElementById('rank-username-input').value.trim();
            const rank = document.getElementById('rank-select').value;
            
            if (!username) {
                showAlert('admin-alert', 'Please enter a username', 'error');
                return;
            }

            try {
                const user = await supabase.from('users').select('*').eq('username', username).single().execute();
                
                if (!user) {
                    showAlert('admin-alert', '‚ùå User not found', 'error');
                    return;
                }

                // Don't change Owner rank
                if (user.rank === 'Owner') {
                    showAlert('admin-alert', '‚ùå Cannot change Owner rank', 'error');
                    return;
                }

                // Update user rank
                await supabase.from('users').update({ rank: rank }).eq('id', user.id).execute();

                showAlert('admin-alert', `‚úÖ ${username} is now ${rank}!`, 'success');
                document.getElementById('rank-username-input').value = '';
            } catch (error) {
                console.error('Assign rank error:', error);
                showAlert('admin-alert', '‚ùå Error assigning rank', 'error');
            }
        }

        async function deleteOwnPost(type, id, postOwnerId) {
            // Check if user owns this post or is admin/owner
            if (postOwnerId !== currentUser.id && !isAdmin && !isOwner) {
                alert('You can only delete your own posts!');
                return;
            }

            if (!confirm('Delete this post?')) return;

            try {
                const table = type === 'review' ? 'reviews' : type === 'quiz' ? 'quizzes' : 'polls';
                await supabase.from(table).delete().eq('id', id).execute();

                if (type === 'review') loadReviews();
                else if (type === 'quiz') loadQuizzes();
                else if (type === 'poll') loadPolls();

                alert('‚úÖ Post deleted');
            } catch (error) {
                console.error('Delete post error:', error);
                alert('‚ùå Error deleting post');
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }

            checkAuth();
        });
    </script>
</body>
</html>
